/** 
 * @program: 		DeviantIO 
 * @author: 		Justin D. Byrne 
 * @version: 		0.0.2 
 * @license: 		GPL-2.0
 */

"use strict";(window=>{let n={accent_colour:"rgba(118, 228, 177, 1)",mousetrap_cdn:"//cdnjs.cloudflare.com/ajax/libs/mousetrap/1.4.6/mousetrap.min.js",favorite_next:!0,time_interval:500,url_reference:void 0,deviantarturl:"https://www.deviantart.com",input_hotkeys:{favorite:["space","enter"],watch:["shift"],previous:["left"],next:["right"],home:["up"],redirect:["down"],user:["/"]}},o={watch:"[data-hook='user_watch_button']",favourite:"[data-hook='fave_button']",stage:"[data-hook='art_stage']",thumbs:"[data-hook='deviation_std_thumb']",user:"[data-hook='user_link']"},t=["https://google.com","https://gmail.com","https://github.com","https://trello.com"],c={site:{home:n.deviantarturl+"/\\B",search:n.deviantarturl+"/search?",watch:n.deviantarturl+"/watch/deviations",daily:n.deviantarturl+"/daily-deviations",popular:n.deviantarturl+"/popular/deviations",topic:n.deviantarturl+"/topic/w+",tag:n.deviantarturl+"/tag/w+",art:n.deviantarturl+"/[^/]+/art/.+"},user:{favourites:n.deviantarturl+"/(?!watch|daily|tag|popular)w+/?favourites",gallery:n.deviantarturl+"/(?!watch|daily|tag|popular)w+/?gallery",home:n.deviantarturl+"/(?!watch|daily|tag|popular)w+"}};var e={position:"absolute","z-index":999,"font-size":"4em","transform-origin":"50% 5em"};let i={notifications:{watch:{css:{...e,animation:"wiggle 2s linear infinite",left:"calc(77% - 1em)",top:"calc(183% - 0em)"},animation:"@keyframes wiggle{0%, 7%    { transform: rotateZ(0);      }15%       { transform: rotateZ(-15deg); }20%       { transform: rotateZ(10deg);  }25%       { transform: rotateZ(-10deg); }30%       { transform: rotateZ(6deg);   }35%       { transform: rotateZ(-4deg);  }40%, 100% { transform: rotateZ(0);      }}"},favourite:{css:{...e,animation:"bounce 1s ease-out infinite",left:"calc(3% - 0em)",top:"calc(183% - 0em)","transform-origin":"50% 5em"},animation:"@keyframes bounce{0%   { transform: translateY(0);     }50%  { transform: translateY(-10px); }100% { transform: translateY(0);     }}"}}},l={off:{border:"none",boxShadow:"none",opacity:1},on:{border:"2px solid "+n.accent_colour,boxShadow:"0px 0px 5px 2px "+n.accent_colour,opacity:.5}},u={favorite:()=>{Mousetrap.bind("%KEYS%",function(e){e.preventDefault(),deviantIO.clearStatus("favourite"),(fave_button=document.querySelectorAll("[data-hook='fave_button']")[0]).click(),deviantIO.config.favorite_next&&Mousetrap.trigger("%NEXT%")})},watch:()=>{Mousetrap.bind("%KEYS%",function(e){e.preventDefault(),deviantIO.clearStatus("watch"),(watch_button=document.querySelectorAll("[data-hook='user_watch_button']")[0]).click()})},previous:()=>{Mousetrap.bind("%KEYS%",function(e){deviantIO.clearStatus("favourite"),deviantIO.clearStatus("watch"),(prev_button=document.querySelectorAll("[data-hook='arrowL']")[0].children[0]).click()})},next:()=>{Mousetrap.bind("%KEYS%",function(e){deviantIO.clearStatus("favourite"),deviantIO.clearStatus("watch"),(next_button=document.querySelectorAll("[data-hook='arrowR']")[0].children[0]).click()})},home:()=>{Mousetrap.bind("%KEYS%",function(e){e.preventDefault();var t;let a=null;for(t of["Home","Back","Profile","Search"])try{a=document.evaluate(`//span[text()='${t}']`,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue.parentElement}catch(e){}null!=a&&a.click()})},redirect:()=>{Mousetrap.bind("%KEYS%",function(e){e.preventDefault(),entry=Math.floor(Math.random()*deviantIO.config.redirect_urls.length),window.open(deviantIO.config.redirect_urls[entry],"_blank")})},user:()=>{Mousetrap.bind("%KEYS%",function(e){e.preventDefault(),(user_button=document.querySelectorAll("[data-hook='user_link']")[0].children[0]).click()})}};function s(e,t){var a=document.createElement("span");a.id=e+"_button",a.innerHTML="favourite"==e?"❤️":"🔍",a.style.cssText=function(e){let t="";for(var[a,r]of Object.entries(e))r="number"==typeof r&&"z-index"!=a?r+"px":r,t+=`${a}: ${r}; `;return t}(t.css),document.getElementsByTagName("header")[0].appendChild(a)}function d(e,t){var a,r;a=t,(r=document.createElement("style")).type="text/css",r.innerHTML=a.animation,document.getElementsByTagName("head")[0].appendChild(r),s(e,t)}function r(e){var t=function(e){let t=void 0;try{t=e.children[1].children[2].children[2].children[1].children[1].children[0].children[0].children[0].outerHTML}catch(e){}return null!=t?t:console.warn("Could not get portrait thumb's path !")}(e);if(/fill-rule=\"evenodd\"/.test(t))for(var a in l.off)e.style[a]=l.off[a];else for(var r in l.on)e.style[r]=l.on[r]}function a(){let e="",r=0;function t(e,t){var a=function(e){let t="";if(1==e.length)t=`'${e[0]}'`;else for(var a in e)t+=`'${e[a]}',`;return t=`[ ${t.replace(/,+$/,"")} ]`}(n.input_hotkeys[e]);return t="favorite"===e?t.replace(/\([^\{]+{/,"").replace(/"%KEYS%"/,a).replace(/"%NEXT%"/,`'${n.input_hotkeys.next[0]}'`):t.replace(/\([^\{]+{/,"").replace(/"%KEYS%"/,a),r?t=t.slice(9):r++,t.substring(0,t.length-1)}for(var a in u){var o=u[a].toString(),o=t(a,o);e+=o}return e}function f(){var e,t;window.addEventListener("load",()=>{var e="text/javascript",t=document.createElement("script"),t=(t.type=e,t.text=a(),t.onload=()=>console.info(">> Mousetrap script has loaded !"),t.onerror=()=>console.warn(">> Mousetrap script has errored !"),document.body.appendChild(t),document.createElement("script"));t.type=e,t.text=setInterval(m,n.time_interval),t.onload=()=>console.info(">> DeviantIO script has loaded !"),t.onerror=()=>console.warn(">> DeviantIO script has errored !"),document.body.appendChild(t)});for(e of document.querySelectorAll(deviantIO.config.ui_data_hooks.favourite))e.addEventListener("click",()=>{deviantIO.checkStatus("favourite")});for(t of document.querySelectorAll(deviantIO.config.ui_data_hooks.watch))t.addEventListener("click",()=>{deviantIO.checkStatus("watch")})}function h(e){return e.charAt(0).toUpperCase()+e.slice(1)}function v(e){var t=document.getElementById(e+"_button");"favourite"==e&&(document.querySelectorAll(o.stage)[0].style.backgroundColor=""),null!=t&&t.remove()}function p(e){var t,a,r="flagged"+h(e)+"Status";"yes"!=(localStorage.getItem(r)||"")&&(!function(e){var t=document.querySelectorAll(o[e])[0];switch(e){case"watch":return null!=t&&"Watch"===t.innerText;case"favourite":return"In Favourites"===t.innerText}}(e)?v(e):(r=e,e=document.getElementById(r+"_button"),t=i.notifications[r],a="flagged"+h(r)+"Status",document.querySelectorAll(o.stage)[0].style.backgroundColor="favourite"==r?n.accent_colour:"",null==e&&d(r,t),localStorage.setItem(a,"yes")))}function m(){var e,t;switch((e=window.location.href)!=n.url_reference&&(n.url_reference=e,localStorage.clear()),function(){var e,t=window.location.href,a=c;for(e in a)for(var r in a[e])if(new RegExp(a[e][r]).test(t))return{category:e,type:r}}().type){case"art":p("favourite"),p("watch");break;case"home":case"search":case"watch":case"daily":case"popular":case"topic":case"tag":case"favourites":case"gallery":var a=0<(t=document.querySelectorAll(o.thumbs)).length?t:console.warn("Portrait thumbs could not be cached !");for(let e=0;e<a.length;e++)r(a[e]);break;default:console.warn(`Nothing to do for present url: ${n.url_reference}.`)}}function g(){var e;window.deviantIO=((e={config:n}).config.redirect_urls=t,e.config.ui_data_hooks=o,e.clearStatus=e=>v(e),e.checkStatus=e=>p(e),e),(e=document.createElement("script")).setAttribute("src",n.mousetrap_cdn),document.head.appendChild(e),f()}void 0===window.deviantIO&&g()})(window);